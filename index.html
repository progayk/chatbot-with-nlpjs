<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/vue@next"></script>
    <script src='./bundle.js'></script>
    <!-- <script>
       
    </script> -->

    <style>
        .msg-c {
            min-width: 600px;
            height: 100%;
            padding: 1rem;
            background-color: #eee;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            max-height: 600px;
            overflow: auto; 
        }

        .msg-box {
            position: relative;
            max-width: 450px;
            width: 450px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.25rem 1rem;
            margin-bottom: 1rem;
            background-color: white;
        }

        .is-right {
            margin-left: auto;
        }

        .msg-sender {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-top: 4px;
            margin-bottom: 0px;
        }

        .msg-input-c {
            max-width: 600px;
            padding: 1rem;
        }

        .msg-input {
            width: 90%;
        }
    </style>
</head>

<body>

    <h1>Chatbot</h1>

    <div id="app">

        <div class="msg-c">

            <div v-for="msg in msgList" :key="msg.id" class="msg-box" :class="{ 'is-right': msg.isBot }">
                <p class="msg-sender">{{ msg.name }}</p>
                <p>
                    {{ msg.text }}
                </p>
            </div>
        </div>

        <div class="msg-input-c">
            <form @submit.prevent="sendMsg">

                <input v-model="msg" type="text" class="msg-input">
                <button type="button" @click="sendMsg" class="send-btn" :disabled="!msg.length">Send</button>
            </form>
        </div>

    </div>


    <script>

        const { containerBootstrap, Nlp, LangTr, Context, Ner , fs } = window.nlpjs;
        let context = new Context()
        const ner = new Ner()
        const Locale = 'tr'

        let nlp;

        (async () => {
            const model = await fetch("./model.nlp").then(res => res.json())
            console.log('model', model);
            
            const container = await containerBootstrap();
            container.use(Nlp);
            container.use(LangTr);
            container.use(Ner)
            nlp = container.get('nlp');
            nlp.settings.autoSave = false;
            nlp.import(model)

        })();



        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max)); 
        }

        const Bot = {
            data() {
                return {
                    msg: '',
                    senderName: "Ayse",
                    msgList: [

                    ],
                }
            },
            methods: {
                newMsg() {
                    return {
                        index: ++this.index,
                        isBot: false,
                        text: this.msg,
                        datetime: new Date().toDateString(),
                        name: this.senderName
                    }
                },
                sendMsg() {
                    this.msgList.push(this.newMsg())
                    let msg = this.msg.slice();
                    this.msg = ''
                    this.nlpProcess(msg)
                },
                async nlpProcess(msg) {
                    try {
                        const res = await nlp.process(Locale, msg, context);
                        console.log('res', res);

                        const ent = await  nlp.extractEntities(Locale, msg, context)
                        console.log('ent', ent);

                        if (res.intent !== 'None') {
                            this.respondDirect(res, ent)
                        } else {
                            this.respondNew(res)
                        }


                    } catch (error) {
                        console.error(error);
                    }
                },
                respondDirect(res, entObj) {
                    let answer = res.answer
                    if (entObj.entities && entObj.entities.length) {
                        answer = this.createResWithEntity(res.answer, entObj)
                    } else {
                        answer = res.answers[getRandomInt(res.answers.length)].answer
                    }

                    let botRes = this.newMsg()
                    botRes.isBot = true
                    botRes.name = 'Bot'
                    botRes.text = answer
                    this.msgList.push(botRes)
                },
                createResWithEntity(answer, entObj) {
                    let replaceStr = '{{' + entObj.entities[0].entity + '}}'
                    return answer.replace(replaceStr, entObj.entities[0].utteranceText)
                },
                respondNew(res) {
                    console.log('respondNew', res);
                }
            }

        }


        Vue.createApp(Bot).mount('#app')

    </script>


</body>

</html>